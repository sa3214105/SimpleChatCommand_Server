<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: UserValidator.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: UserValidator.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import { Mutex } from "async-mutex";
import crypto from "crypto";
import { CDBManager } from "./CDBManager.js";
import {IUserValidator} from "./SimpleChatCommand_Server.js"
/**
 * @class
 * @extends IUserValidator
*/
export class UserValidator_SQLite extends IUserValidator{
    static #LAST_VER=0.1;
    #m_Users=new Map();
    #m_DBVer=0;
    #m_DBManager=null;
    #IsInit=false;
    #m_Mutex=new Mutex();
    constructor(dbPath){
        super();
        this.#m_DBManager=new CDBManager(dbPath);
        this.#Init();
    }
    async #Init(){
        if(await this.#m_DBManager.IsTableExist("DB_INFO")){
            let info = await this.#m_DBManager.Get("SELECT VERSION FROM 'DB_INFO'");
            if(!info)throw "Failed to read database";
            this.m_DBVer=info["VERSION"];
        }else{
            let createSql="CREATE TABLE 'DB_INFO'('VERSION' REAL)";
            let insertSql="INSERT INTO 'DB_INFO' VALUES (?)";
            await this.#m_DBManager.Run(createSql);
            await this.#m_DBManager.Run(insertSql,UserValidator_SQLite.#LAST_VER);
        }
        let tableSql="CREATE TABLE IF NOT EXISTS 'USERINFO'('NAME' TEXT NOT NULL PRIMARY KEY,'PASSWORD' TEXT NOT NULL,'SALT' TEXT NOT NULL);";
        let indexSql="CREATE INDEX IF NOT EXISTS 'USERINFO_INDEX' ON 'USERINFO'('NAME')";
        await this.#m_DBManager.Run(tableSql);
        await this.#m_DBManager.Run(indexSql);
        this.#IsInit=true;
    }
    async #WaitInit(){
        return await new Promise((resolve,reject)=>{
            let timeCounter=0;
            let timeOut=10000;//10sec;
            let callback=()=>{
                if(this.#IsInit){
                    resolve()
                }else{
                    if(timeCounter++&lt;timeOut){
                        setTimeout(callback,1);
                    }else{
                        reject("time out");
                    }
                }
            };
            callback();
        });
    }
    async CreateUser(userName,password){
        await this.#WaitInit();
        const release = await this.#m_Mutex.acquire();
        let ret=false;
        if(!(await this.#IsUserNameExist(userName))){
            let salt=Math.random().toString()
            let hashpwd=this.#HashPassword(password,salt);
            await this.#m_DBManager.Run(`INSERT INTO USERINFO ("NAME","PASSWORD","SALT") VALUES  (?,?,?);`,[userName,hashpwd,salt]);
            ret=true;
        }
        release();
        return ret;
    }
    async Auth(userName,password){
        await this.#WaitInit();
        return this.#VerifyPassword(userName,password);
    }
    async #IsUserNameExist(userName){
        let data=await this.#m_DBManager.Get(`SELECT count("NAME") FROM USERINFO WHERE "NAME"=?`,userName);
        return  data["count(\"NAME\")"] === 1;
    }
    #HashPassword(password,salt){
        crypto.randomBytes(16).toString('hex');
        let ret=crypto.pbkdf2Sync(password,salt,1000,64,"sha512").toString();
        return ret;
    }
    async #VerifyPassword(userName,password){
        let ret=false;
        let data =await this.#m_DBManager.Get(`SELECT "PASSWORD","SALT" FROM "USERINFO" WHERE "NAME"=?`,userName);
        if(data){
            let passwordDB=data["PASSWORD"];
            let salt=data["SALT"];
            ret=this.#HashPassword(password,salt)===passwordDB;
        }
        return ret;
    }
}</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BroadcastStruct.html">BroadcastStruct</a></li><li><a href="CommandStruct.html">CommandStruct</a></li><li><a href="LoginStruct.html">LoginStruct</a></li><li><a href="MessageHandlerResult.html">MessageHandlerResult</a></li><li><a href="MessageManagerWebSocket.html">MessageManagerWebSocket</a></li><li><a href="MessageStruct.html">MessageStruct</a></li><li><a href="SimpleChatCommand_Server.html">SimpleChatCommand_Server</a></li><li><a href="UserStruct.html">UserStruct</a></li><li><a href="UserValidator_SQLite.html">UserValidator_SQLite</a></li></ul><h3>Interfaces</h3><ul><li><a href="IMessageManager.html">IMessageManager</a></li><li><a href="IUserValidator.html">IUserValidator</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.11</a> on Sun Oct 23 2022 02:16:55 GMT+0800 (台北標準時間)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
